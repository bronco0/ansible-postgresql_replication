---

- hosts: all
  tasks:
  - apt:
      name:
        - gnupg
        - locales
        - rsync
      state: present
      update_cache: yes

- hosts: all
  vars:
    replication_user: "replicate"
    replication_password: "r3pl1c6t0r"

  roles:
    - role: '../../.'
      postgresl__version: 11
      postgresql__global_config_options:
        - option: listen_addresses
          value: '*'
        - option: log_min_duration_statement
          value: 1000
      postgresql__hba_entries:
        - {type: local, database: all, user: postgres, auth_method: peer}
        - {type: local, database: all, user: all, auth_method: peer}
        - {type: host, database: all, user: all, address: "*", auth_method: md5}
        - {type: hostssl, database: replication, user: "{{ replication_user }}", address: "*" ,auth_method: md5}
      postgresql__users:
        - {name: "{{ replication_user }}", password: "{{ replication_password }}", role_attr_flags: "REPLICATION"}
